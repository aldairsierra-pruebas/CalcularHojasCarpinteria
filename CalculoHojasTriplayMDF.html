  <!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora de Planchas ‚Äî Optimizaci√≥n y Layout (Debug)</title>
  <style>
    :root{--bg:#0f1724;--card:#071224;--muted:#9aa4b2;--accent:#7dd3fc;--glass:rgba(255,255,255,0.03);}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071224,#03101a);color:#e6eef6}
    .app{max-width:1150px;margin:18px auto;padding:14px}
    header{display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:14px;margin-top:12px}
    .card{background:linear-gradient(180deg,var(--card),#041224);padding:12px;border-radius:10px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=number],select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--glass);background:transparent;color:inherit}
    .row{display:flex;gap:8px}
    .btn{padding:8px 12px;border-radius:10px;background:var(--accent);color:#012235;font-weight:700;border:none;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--glass);color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:6px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03)}
    #sheets{display:flex;flex-wrap:wrap;gap:12px}
    .sheetBox{background:#fff;padding:6px;border-radius:8px}
    .sheetLabel{font-size:12px;color:#041c24;margin-top:6px}
    .mini{font-size:12px;color:var(--muted)}
    #status{margin-top:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
    @media(max-width:980px){.grid{grid-template-columns:1fr;}.sheetBox svg{max-width:100%}}
  </style>
</head>
<body>
  <main class="app">
    <header>
      <div>
        <h1>Calculadora de Planchas ‚Äî Optimizaci√≥n</h1>
        <p class="lead">Planchas fijas: <strong>2440 √ó 1220 mm</strong>. Guillotine-nesting. (Versi√≥n con diagn√≥stico)</p>
      </div>
    </header>

    <div class="grid">
      <section class="card" aria-label="entrada">
        <label>Par√°metros</label>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="width:140px">
            <label>Tama√±o plancha</label>
            <input type="text" value="2440 √ó 1220 mm (Fijo)" disabled />
          </div>
          <div style="width:110px">
            <label>Kerf (mm)</label>
            <input id="kerf" type="number" min="0" value="3" />
          </div>
          <div style="width:110px">
            <label>Desperdicio %</label>
            <input id="waste" type="number" min="0" max="50" value="5" />
          </div>
        </div>

        <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

        <label>A√±adir pieza</label>
        <div class="row" style="align-items:center">
          <input id="pieceW" type="number" placeholder="Ancho (ej. 600)" />
          <input id="pieceH" type="number" placeholder="Alto (ej. 400)" />
          <input id="pieceQ" type="number" placeholder="Cant." value="1" style="width:84px" />
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <select id="orient">
            <option value="either">Permitir rotaci√≥n</option>
            <option value="fixed">Sin rotar</option>
          </select>
          <button id="addBtn" class="btn">Agregar</button>
          <button id="exampleBtn" class="btn ghost">Cargar ejemplo</button>
          <button id="testBtn" class="btn">Probar demo y optimizar</button>
        </div>

        <div style="margin-top:10px">
          <table id="itemsTable">
            <thead><tr><th>Pieza (mm)</th><th>Cant.</th><th>Orient.</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="packBtn" class="btn">Optimizar y Dibujar</button>
          <button id="clearBtn" class="btn ghost">Borrar</button>
        </div>

        <div id="status">Estado: listo. Si no ves nada, pulsa <strong>Probar demo y optimizar</strong> para ver un ejemplo funcional.</div>

      </section>

      <aside class="card" aria-label="resultados">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Layouts (por hoja)</strong>
          <div class="mini">Escala visual</div>
        </div>
        <div id="sheets" style="margin-top:10px"></div>

        <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="mini">Planchas necesarias:</div>
            <div id="sheetsNeeded" style="font-size:20px;font-weight:700">‚Äî</div>
          </div>
          <div>
            <button id="exportCSV" class="btn ghost">Exportar CSV</button>
          </div>
        </div>

        <div style="margin-top:10px">
          <strong>Lista detallada por hoja</strong>
          <div id="perSheetList" style="max-height:260px;overflow:auto;margin-top:8px"></div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // DEBUG-FRIENDLY version with better error reporting and a demo button
    const SHEET_W = 2440, SHEET_H = 1220;
    let items = [];
    const $ = id => document.getElementById(id);
    const tbody = document.querySelector('#itemsTable tbody');

    function setStatus(msg, isError){ const s = $('#status'); s.textContent = 'Estado: ' + msg; s.style.color = isError ? '#ff9b9b' : ''; }

    function renderItems(){
      tbody.innerHTML = '';
      items.forEach((it, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.w} √ó ${it.h} mm</td><td>${it.q}</td><td class="mini">${it.orient==='either'?'Permite rotar':'Fijo'}</td><td><button data-idx="${idx}" class="trash">üóë</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('.trash').forEach(btn=>btn.addEventListener('click', e=>{ items.splice(+e.target.dataset.idx,1); renderItems(); }));
    }

    // add piece
    $('#addBtn').addEventListener('click', ()=>{
      const w = Math.round(Number($('#pieceW').value||0));
      const h = Math.round(Number($('#pieceH').value||0));
      const q = Math.max(1, Math.floor(Number($('#pieceQ').value||1)));
      const orient = $('#orient').value;
      if(!w || !h){ setStatus('Ingresa ancho y alto de la pieza.', true); return }
      items.push({w,h,q,orient}); renderItems(); setStatus('Pieza a√±adida.');
      $('#pieceW').value='';$('#pieceH').value='';$('#pieceQ').value='1';
    });

    $('#clearBtn').addEventListener('click', ()=>{ items.length=0; renderItems(); $('#sheets').innerHTML=''; $('#perSheetList').innerHTML=''; $('#sheetsNeeded').textContent='‚Äî'; setStatus('Listo, todo borrado.'); });

    $('#exampleBtn').addEventListener('click', ()=>{ items = [ {w:600,h:400,q:8,orient:'either'}, {w:300,h:1800,q:2,orient:'fixed'}, {w:1200,h:600,q:3,orient:'either'} ]; renderItems(); setStatus('Ejemplo cargado.'); });

    $('#testBtn').addEventListener('click', ()=>{ try{ $('#exampleBtn').click(); setTimeout(()=>$('#packBtn').click(), 80); }catch(e){ console.error(e); setStatus('Error al ejecutar demo: '+e.message, true); } });

    // Expand items to single-piece list
    function expandItems(items){
      const list = [];
      items.forEach(it=>{ for(let i=0;i<it.q;i++) list.push({w:it.w,h:it.h,orient:it.orient,id:Math.random().toString(36).slice(2,9)}); });
      return list;
    }

    function rectArea(r){return r.w*r.h}

    function fits(rect, piece){
      const effW = rect.w; const effH = rect.h;
      const tryNoRot = (piece.w <= effW && piece.h <= effH);
      const tryRot = (piece.orient==='either') && (piece.h <= effW && piece.w <= effH);
      if(tryNoRot) return {fit:true,rot:false};
      if(tryRot) return {fit:true,rot:true};
      return {fit:false};
    }

    function splitRect(rect, piece, rotated, kerf){
      const pw = rotated ? piece.h : piece.w;
      const ph = rotated ? piece.w : piece.h;
      const placed = {x:rect.x, y:rect.y, w:pw, h:ph, id:piece.id, rot:rotated, original:piece};
      const rightW = rect.w - pw - kerf;
      const rightH = ph;
      const bottomW = rect.w;
      const bottomH = rect.h - ph - kerf;
      const newRects = [];
      if(rightW>0 && rightH>0) newRects.push({x:rect.x + pw + kerf, y:rect.y, w:rightW, h:rightH});
      if(bottomW>0 && bottomH>0) newRects.push({x:rect.x, y:rect.y + ph + kerf, w:bottomW, h:bottomH});
      return {placed,newRects};
    }

    function packSheet(pieces, kerf){
      const freeRects = [{x:0,y:0,w:SHEET_W,h:SHEET_H}];
      const placed = [];
      // try to place each piece once (greedy)
      for(const piece of pieces){
        let bestChoice = null;
        for(let i=0;i<freeRects.length;i++){
          const rect = freeRects[i];
          const f = fits(rect,piece);
          if(!f.fit) continue;
          const pw = f.rot?piece.h:piece.w; const ph = f.rot?piece.w:piece.h;
          const waste = rectArea(rect) - (pw*ph);
          if(bestChoice===null || waste < bestChoice.waste){ bestChoice = {rectIdx:i,rot:f.rot,waste}; }
        }
        if(bestChoice===null) continue;
        const rect = freeRects.splice(bestChoice.rectIdx,1)[0];
        const {placed:pl,newRects} = splitRect(rect,piece,bestChoice.rot,kerf);
        placed.push(pl);
        // add new rects
        for(const nr of newRects) freeRects.push(nr);
        freeRects.sort((a,b)=>b.w*b.h - a.w*a.h);
      }
      return {placed,freeRects};
    }

    function doPacking(allPieces, kerf, wastePct){
      const remaining = allPieces.slice();
      const sheets = [];
      let loopGuard = 0;
      while(remaining.length>0){
        loopGuard++; if(loopGuard>2000){ alert('Demasiadas iteraciones - abortando'); break; }
        const res = packSheet(remaining, kerf);
        if(res.placed.length===0){
          // if first remaining cannot fit, alert
          const p = remaining.shift();
          const canFit = (p.w<=SHEET_W && p.h<=SHEET_H) || (p.orient==='either' && p.h<=SHEET_W && p.w<=SHEET_H);
          if(!canFit){ setStatus('Una pieza es m√°s grande que la hoja: ' + p.w + '√ó' + p.h + ' mm', true); return null; }
          const singleRes = packSheet([p], kerf);
          sheets.push({placed: singleRes.placed});
          continue;
        }
        sheets.push({placed: res.placed});
        const placedIds = new Set(res.placed.map(x=>x.id));
        for(let i=remaining.length-1;i>=0;i--) if(placedIds.has(remaining[i].id)) remaining.splice(i,1);
      }
      const finalCount = Math.ceil(sheets.length * (1 + wastePct/100));
      while(sheets.length < finalCount) sheets.push({placed:[]});
      return sheets;
    }

    function drawSheets(sheets, kerf){
      const container = $('#sheets'); container.innerHTML = '';
      sheets.forEach((s,si)=>{
        const box = document.createElement('div'); box.className='sheetBox';
        const maxW = 420, maxH = 210; const scale = Math.min(maxW / SHEET_W, maxH / SHEET_H);
        const svgW = Math.round(SHEET_W * scale), svgH = Math.round(SHEET_H * scale);
        const xmlns = 'http://www.w3.org/2000/svg';
        const svg = document.createElementNS(xmlns,'svg'); svg.setAttribute('width',svgW); svg.setAttribute('height',svgH); svg.setAttribute('viewBox',`0 0 ${SHEET_W} ${SHEET_H}`);
        svg.style.display='block'; svg.style.background='#fff'; svg.style.borderRadius='6px';
        const border = document.createElementNS(xmlns,'rect'); border.setAttribute('x',0); border.setAttribute('y',0); border.setAttribute('width',SHEET_W); border.setAttribute('height',SHEET_H); border.setAttribute('fill','#fff'); border.setAttribute('stroke','#0b2b33'); border.setAttribute('stroke-width',2);
        svg.appendChild(border);
        s.placed.forEach((p,pi)=>{
          const g = document.createElementNS(xmlns,'g');
          const r = document.createElementNS(xmlns,'rect'); r.setAttribute('x',p.x); r.setAttribute('y',p.y); r.setAttribute('width',p.w); r.setAttribute('height',p.h); r.setAttribute('fill','#e6f7ff'); r.setAttribute('stroke','#036'); r.setAttribute('stroke-width',1);
          g.appendChild(r);
          const txt = document.createElementNS(xmlns,'text'); txt.setAttribute('x',p.x + 6); txt.setAttribute('y',p.y + 14); txt.setAttribute('font-size',12); txt.setAttribute('fill','#012b33'); txt.textContent = `${Math.round(p.w)}√ó${Math.round(p.h)}`;
          g.appendChild(txt);
          svg.appendChild(g);
          // cut lines
          const lines = [ {x1:p.x,y1:p.y,x2:p.x+p.w,y2:p.y}, {x1:p.x,y1:p.y+p.h,x2:p.x+p.w,y2:p.y+p.h}, {x1:p.x,y1:p.y,x2:p.x,y2:p.y+p.h}, {x1:p.x+p.w,y1:p.y,x2:p.x+p.w,y2:p.y+p.h} ];
          lines.forEach(L=>{ const ln = document.createElementNS(xmlns,'line'); ln.setAttribute('x1',L.x1); ln.setAttribute('y1',L.y1); ln.setAttribute('x2',L.x2); ln.setAttribute('y2',L.y2); ln.setAttribute('stroke','#9aa4b2'); ln.setAttribute('stroke-width',0.4); svg.appendChild(ln); });
        });
        box.appendChild(svg);
        const lbl = document.createElement('div'); lbl.className='sheetLabel'; lbl.textContent = 'Hoja ' + (si+1) + ' ‚Äî ' + s.placed.length + ' piezas';
        box.appendChild(lbl);
        container.appendChild(box);
      });
    }

    function renderPerSheetList(sheets){
      const out = $('#perSheetList'); out.innerHTML = '';
      sheets.forEach((s,si)=>{
        const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.03)';
        const header = document.createElement('div'); header.innerHTML = `<strong>Hoja ${si+1}</strong> ‚Äî ${s.placed.length} piezas`;
        div.appendChild(header);
        if(s.placed.length===0){ const p = document.createElement('div'); p.className='mini'; p.textContent = 'Hoja reservada por desperdicio/seguridad'; div.appendChild(p);} else {
          const tbl = document.createElement('table'); const tb = document.createElement('tbody');
          s.placed.forEach(p=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${Math.round(p.w)}√ó${Math.round(p.h)} mm</td><td class="mini">(${Math.round(p.x)},${Math.round(p.y)})</td><td class="mini">rot:${p.rot? 's√≠' : 'no'}</td>`; tb.appendChild(tr); }); tbl.appendChild(tb); div.appendChild(tbl);
        }
        out.appendChild(div);
      });
    }

    $('#packBtn').addEventListener('click', ()=>{
      try{
        if(items.length===0){ setStatus('Agrega al menos una pieza.', true); return }
        const kerf = Number($('#kerf').value)||0; const waste = Number($('#waste').value)||0; setStatus('Calculando...');
        const list = expandItems(items); list.sort((a,b)=> (b.w*b.h) - (a.w*a.h));
        const sheets = doPacking(list, kerf, waste);
        if(sheets===null){ setStatus('Error en packing (revisa mensajes).', true); return }
        drawSheets(sheets, kerf); renderPerSheetList(sheets); $('#sheetsNeeded').textContent = sheets.length; setStatus('Optimizaci√≥n completa.');
        console.log('Sheets:',sheets);
      }catch(e){ console.error(e); setStatus('Error: '+e.message, true); }
    });

    $('#exportCSV').addEventListener('click', ()=>{
      try{
        if(items.length===0){ setStatus('No hay items para exportar.', true); return }
        const kerf = Number($('#kerf').value)||0; const waste = Number($('#waste').value)||0;
        const list = expandItems(items); list.sort((a,b)=> (b.w*b.h) - (a.w*a.h));
        const sheets = doPacking(list, kerf, waste); if(!sheets) return;
        const rows = [['Hoja','Ancho_mm','Alto_mm','X_mm','Y_mm','Rotado']];
        sheets.forEach((s,si)=>{ s.placed.forEach(p=>rows.push([si+1,Math.round(p.w),Math.round(p.h),Math.round(p.x),Math.round(p.y), p.rot? 's√≠' : 'no'])); });
        const csv = rows.map(r=>r.join(',')).join('
'); const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='layout_planchas.csv'; a.click(); URL.revokeObjectURL(url);
        setStatus('CSV generado.');
      }catch(e){ console.error(e); setStatus('Error exportando CSV: '+e.message, true); }
    });

    // init
    renderItems(); setStatus('Listo. Pulsa "Probar demo y optimizar" si no ves nada.');
  </script>
</body>
</html>
